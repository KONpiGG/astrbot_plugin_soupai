# AstrBot 海龟汤推理游戏插件

一个为 AstrBot 开发的 AI 海龟汤推理游戏插件，通过调用 AstrBot 的 LLM 服务商实现自动生成谜题、接收用户提问、智能判断是否猜中故事等功能。

## 🎮 功能特性

- **自动生成谜题** - 使用 LLM 自动生成海龟汤谜题和完整故事
- **智能问答系统** - 使用 LLM 判断用户提问并回复"是/否/是也不是"
- **验证系统** - 支持用户通过 `/验证` 指令验证完整推理过程
- **存储库系统** - 自动生成并存储备用故事，优先使用存储库内容
- **会话控制** - 一次仅允许一个群进行一个游戏，防止混乱
- **超时机制** - 游戏超时自动结束并揭晓答案
- **管理员功能** - 支持管理员强制结束游戏和备用故事管理

## 📋 使用指令

### 基础指令

- `/汤` - 开始海龟汤游戏
- `/揭晓` - 查看完整故事并结束游戏
- `/验证 <推理内容>` - 验证用户推理的准确性
- `/汤状态` - 查看当前游戏状态（游戏进行中也可使用）
- `/备用状态` - 查看备用故事存储库状态
- `/汤提供商` - 查看可用的 LLM 提供商列表
- `/汤配置` - 查看当前插件配置

### 管理员指令

- `/强制结束` - 强制结束当前游戏（仅管理员可用，可在游戏进行中使用）
- `/备用开始` - 手动开始生成备用故事（仅管理员可用）
- `/备用结束` - 停止生成备用故事（仅管理员可用）

## 🎯 游戏流程

1. **开始游戏** - 用户发送 `/汤` 指令
2. **获取谜题** - 优先从存储库获取故事，存储库为空时现场生成
3. **公布题面** - 将题面公布至群聊，并启动会话控制
4. **用户互动** - 群内用户可以通过以下方式参与：
   - @机器人 + 任意陈述/问题（AI 回复：是、否、是也不是）
   - `/验证 <推理内容>` 验证完整推理过程
5. **游戏结束** - 用户输入 `/揭晓` 或验证成功时结束游戏

## 🔍 验证系统

用户可以通过 `/验证` 指令验证自己的完整推理过程：

- **完全还原**：推理与标准答案高度一致，包括核心逻辑与关键细节
- **核心推理正确**：推理的大方向或关键反转已覆盖，但部分细节有出入
- **部分正确**：理解了部分情节或动机，但因果链不完整
- **基本不符**：推理与真相严重不符

当等级为"完全还原"或"核心推理正确"时，判定为猜中，游戏结束。

## 🔧 技术特性

- **LLM 集成** - 使用 AstrBot 的 Provider 接口调用大语言模型
- **双 LLM 分离** - 支持分别配置生成谜题和判断问答的 LLM 提供商
- **存储库系统** - 自动生成并持久化存储备用故事
- **会话管理** - 基于群聊的会话控制，支持多用户参与
- **验证系统** - 智能验证用户推理的准确性和完整性
- **错误处理** - 完善的异常处理和边界情况处理
- **状态管理** - 游戏状态持久化，防止多个游戏同时进行
- **数据持久化** - 数据存储在 AstrBot 的 data 目录，插件更新时数据不丢失

## 📦 依赖要求

- AstrBot >= v3.4.36
- 已配置 LLM 服务商（用于生成谜题和判断问答）

## 🚀 安装使用

1. 将插件放置在 `AstrBot/data/plugins/` 目录下
2. 在 AstrBot WebUI 的插件管理处启用插件
3. 在插件配置页面设置 LLM 提供商和其他参数
4. 确保已配置 LLM 服务商
5. 在群聊中使用 `/汤` 开始游戏

## ⚙️ 配置说明

插件支持以下配置项：

- **生成谜题的 LLM 服务商** - 选择用于生成海龟汤谜题的 LLM 服务商（留空使用默认）
- **判断问答的 LLM 服务商** - 选择用于判断用户问答的 LLM 服务商（推荐 DeepSeek-Chat）

- **游戏超时时间** - 游戏超时时间（秒）
- **存储库最大容量** - 存储库最多保存多少个备用故事（默认 50）
- **自动生成开始时间** - 每天自动生成备用故事的开始时间（小时，24小时制，默认 3）
- **自动生成结束时间** - 每天自动生成备用故事的结束时间（小时，24小时制，默认 6）

配置修改后需要重载插件生效。

## 📝 开发说明

本插件基于 AstrBot 插件开发框架构建，使用了以下核心功能：

- `@register` 装饰器注册插件
- `@filter.command` 注册指令处理器
- `session_waiter` 实现会话控制
- `self.context.get_using_provider()` 调用 LLM 服务

## 🤝 贡献

欢迎提交 Issue 和 Pull Request 来改进这个插件！

## 📄 许可证

本项目采用 MIT 许可证。
